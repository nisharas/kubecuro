name: Project Quality Check

on: [push, pull_request]

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Download Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Project & Testing Tools
        run: |
          python -m pip install --upgrade pip
          # 1. Purge metadata to keep the path clean
          rm -rf build/ dist/ *.egg-info src/*.egg-info .pytest_cache
          
          # 2. Install EVERYTHING from your requirements file
          # This will get argcomplete, ruamel.yaml, PyYAML, and rich
          pip install --no-cache-dir -r requirements.txt
          
          # 3. Double-check Rich and Pytest are exactly what we want
          pip install --no-cache-dir --force-reinstall rich==14.2.0 pytest
          
          # 4. Link the project source without messing with dependencies
          pip install --no-cache-dir --no-deps -e .

      - name: DEBUG - Verify Installation  # ← NEW: See what's WRONG
        run: |
          echo "=== PYTHON PATH ==="
          which python
          python --version
          echo "=== INSTALLED PACKAGES ==="
          pip list | grep -E "(yaml|rich|kubecuro)"
          echo "=== TEST IMPORTS ==="
          python -c "from rich.console import Console; print('✅ Rich Console OK')"
          python -c "import yaml; print('✅ PyYAML OK')"
          python -c "import kubecuro; print('✅ KUBECURO OK')" || echo "❌ KUBECURO FAILED"
          echo "=== TEST KUBECURO MAIN ==="
          python -m kubecuro.main --help || echo "❌ KUBECURO.MAIN FAILED"

      - name: Environment Truth-Check
        run: |
          python -m pip show rich
          python --version

      - name: Clean Cache and Run Tests
        run: |
          find . -name "*.pyc" -delete
          find . -name "__pycache__" -delete
          python -m pytest tests/ -v --tb=short
